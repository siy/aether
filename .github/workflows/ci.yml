name: CI

on:
  push:
    branches: [ main, feature/*, release/*, release-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: 'maven'

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>\${env.GITHUB_ACTOR}</username><password>\${env.GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml

      - name: Run tests and build
        run: mvn --no-transfer-progress --batch-mode --update-snapshots package         env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml
          retention-days: 7

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    # Enabled: Health checks work during cluster formation
    if: github.ref == 'refs/heads/main' || contains(github.event.head_commit.message, '[e2e]')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: 'maven'

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>\${env.GITHUB_ACTOR}</username><password>\${env.GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build E2E tests module
        run: mvn --no-transfer-progress --batch-mode compile test-compile -pl e2e-tests -am -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests
        run: |
          # Run only ClusterFormationE2ETest as smoke test in CI (faster)
          # Full E2E suite can be run manually with [e2e-full] in commit message
          if [[ "${{ contains(github.event.head_commit.message, '[e2e-full]') }}" == "true" ]]; then
            mvn --no-transfer-progress --batch-mode verify -pl e2e-tests -DskipE2ETests=false
          else
            mvn --no-transfer-progress --batch-mode verify -pl e2e-tests -DskipE2ETests=false \
              -Dit.test=ClusterFormationE2ETest
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AETHER_E2E_IMAGE: ghcr.io/${{ github.repository_owner }}/aether-node:latest

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: e2e-tests/target/failsafe-reports/*.xml
          retention-days: 7

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release')
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'zulu'
          cache: 'maven'

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>\${env.GITHUB_ACTOR}</username><password>\${env.GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml

      - name: Build JARs
        run: mvn --no-transfer-progress --batch-mode package -DskipTests         env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

      - name: Build and push Aether Node
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/aether-node/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/aether-node:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/aether-node:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Aether Forge
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/aether-forge/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/aether-forge:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/aether-forge:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
